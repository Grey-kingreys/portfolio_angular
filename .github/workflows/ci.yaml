
name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ R√©cup√®re le code source
      - uses: actions/checkout@v3

      # 2Ô∏è‚É£ Installe Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3Ô∏è‚É£ Installe les d√©pendances
      - name: Install dependencies
        run: npm ci  # üîπ Plus rapide et fiable que npm install en CI

      # 4Ô∏è‚É£ V√©rifie le code avec le linter
      - name: Run Linter
        run: npm run lint

      # 5Ô∏è‚É£ V√©rifie la mise en forme avec Prettier
      - name: Check Prettier formatting
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx}"
        # üîπ --check au lieu de --write (on ne modifie pas en CI)

      # 6Ô∏è‚É£ Build du projet
      - name: Build project
        run: npm run build

      # 7Ô∏è‚É£ Audit Lighthouse (optionnel)
      - name: Run Lighthouse CI
        run: npx lhci autorun
        continue-on-error: true  # üîπ N'arr√™te pas le d√©ploiement si Lighthouse √©choue

      # 8Ô∏è‚É£ Upload du rapport Lighthouse
      - name: Upload Lighthouse Report
        if: always()  # üîπ Upload m√™me si Lighthouse √©choue
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/**/*

      # 9Ô∏è‚É£ D√©ploiement sur Vercel
      - name: Deploy to Vercel
        if: success()
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm i -g vercel
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN